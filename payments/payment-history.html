<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Payment History - CityMaid</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        poppins: ['Poppins', 'sans-serif'],
                    },
                    colors: {
                        brand: {
                            primary: '#4F46E5',
                            secondary: '#4338CA',
                            light: '#EEF2FF',
                        }
                    }
                }
            }
        }
    </script>
    <style>
        .payment-card {
            @apply bg-white rounded-xl p-6 border border-gray-100 hover:border-indigo-100 transition-all duration-300;
        }
        .status-badge {
            @apply px-3 py-1 rounded-full text-sm font-medium;
        }
        .status-badge.completed {
            @apply bg-green-100 text-green-700;
        }
        .status-badge.pending {
            @apply bg-yellow-100 text-yellow-700;
        }
        .status-badge.failed {
            @apply bg-red-100 text-red-700;
        }
        .filter-button {
            @apply px-4 py-2 rounded-lg text-gray-700 hover:bg-gray-50 transition-colors;
        }
        .filter-button.active {
            @apply bg-brand-light text-brand-primary font-semibold;
        }
    </style>
</head>
<body class="bg-gray-50 font-poppins">
    <!-- Navigation Bar -->
    <nav class="bg-white shadow-lg sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-20">
                <div class="flex items-center">
                    <a href="index.html" class="text-3xl font-bold text-brand-primary tracking-tight">City<span class="text-brand-secondary">Maid</span></a>
                </div>
                <div class="hidden md:flex items-center space-x-6">
                    <a href="index.html" class="text-gray-700 hover:text-brand-primary font-medium transition-colors">Home</a>
                    <a href="find-maids.html" class="text-gray-700 hover:text-brand-primary font-medium transition-colors">Find Maids</a>
                    <a href="find-jobs.html" class="text-gray-700 hover:text-brand-primary font-medium transition-colors">Find Jobs</a>
                    <a href="dashboard.html" class="text-gray-700 hover:text-brand-primary font-medium transition-colors">Dashboard</a>
                    <div id="userMenu" class="relative">
                        <button class="flex items-center space-x-2 text-gray-700 hover:text-brand-primary">
                            <img id="userAvatar" src="https://via.placeholder.com/32" class="w-8 h-8 rounded-full">
                            <span id="userName">Loading...</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <main class="py-12">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <!-- Header -->
            <div class="mb-8">
                <h1 class="text-3xl font-bold text-gray-900 mb-2">Payment History</h1>
                <p class="text-gray-600">Track all your transactions and payments</p>
            </div>

            <!-- Stats Grid -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <div class="bg-white rounded-xl p-6 shadow-sm">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-500">Total Spent</p>
                            <h3 class="text-2xl font-bold text-gray-900" id="totalSpent">Rs. 0</h3>
                        </div>
                        <div class="w-12 h-12 bg-brand-light rounded-full flex items-center justify-center">
                            <i class="fas fa-wallet text-xl text-brand-primary"></i>
                        </div>
                    </div>
                </div>
                <div class="bg-white rounded-xl p-6 shadow-sm">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-500">Total Transactions</p>
                            <h3 class="text-2xl font-bold text-gray-900" id="totalTransactions">0</h3>
                        </div>
                        <div class="w-12 h-12 bg-brand-light rounded-full flex items-center justify-center">
                            <i class="fas fa-exchange-alt text-xl text-brand-primary"></i>
                        </div>
                    </div>
                </div>
                <div class="bg-white rounded-xl p-6 shadow-sm">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-500">This Month</p>
                            <h3 class="text-2xl font-bold text-gray-900" id="monthlySpent">Rs. 0</h3>
                        </div>
                        <div class="w-12 h-12 bg-brand-light rounded-full flex items-center justify-center">
                            <i class="fas fa-calendar text-xl text-brand-primary"></i>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Filters and Search -->
            <div class="bg-white rounded-xl p-6 mb-8">
                <div class="flex flex-col md:flex-row gap-4">
                    <div class="flex-1">
                        <input type="text" id="searchInput" placeholder="Search transactions..." 
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-primary focus:border-brand-primary">
                    </div>
                    <div class="flex gap-4">
                        <select id="statusFilter" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-primary focus:border-brand-primary">
                            <option value="all">All Status</option>
                            <option value="completed">Completed</option>
                            <option value="pending">Pending</option>
                            <option value="failed">Failed</option>
                        </select>
                        <select id="dateFilter" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-primary focus:border-brand-primary">
                            <option value="all">All Time</option>
                            <option value="today">Today</option>
                            <option value="week">This Week</option>
                            <option value="month">This Month</option>
                            <option value="year">This Year</option>
                        </select>
                        <button id="exportBtn" class="bg-brand-light text-brand-primary px-6 py-2 rounded-lg hover:bg-indigo-100 transition-colors">
                            <i class="fas fa-download mr-2"></i>Export
                        </button>
                    </div>
                </div>
            </div>

            <!-- Payments List -->
            <div id="paymentsContainer" class="space-y-4">
                <!-- Loading State -->
                <div class="animate-pulse space-y-4">
                    <div class="h-24 bg-gray-100 rounded-xl"></div>
                    <div class="h-24 bg-gray-100 rounded-xl"></div>
                    <div class="h-24 bg-gray-100 rounded-xl"></div>
                </div>
            </div>

            <!-- Empty State -->
            <div id="emptyState" class="hidden text-center py-12">
                <div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-receipt text-2xl text-gray-400"></i>
                </div>
                <h3 class="text-lg font-semibold text-gray-900 mb-2">No Transactions Found</h3>
                <p class="text-gray-600 mb-6">You haven't made any payments yet.</p>
                <div class="flex justify-center space-x-4">
                    <a href="find-maids.html" class="bg-brand-primary text-white px-6 py-3 rounded-lg hover:bg-brand-secondary transition-colors font-semibold">
                        Find Maids
                    </a>
                    <a href="find-jobs.html" class="bg-white text-brand-primary px-6 py-3 rounded-lg hover:bg-gray-50 transition-colors font-semibold border-2 border-brand-primary">
                        Find Jobs
                    </a>
                </div>
            </div>

            <!-- Pagination -->
            <div id="pagination" class="hidden mt-8 flex justify-center space-x-2">
                <button id="prevPage" class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 disabled:opacity-50">
                    Previous
                </button>
                <div id="pageNumbers" class="flex space-x-2">
                    <!-- Page numbers will be inserted here -->
                </div>
                <button id="nextPage" class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 disabled:opacity-50">
                    Next
                </button>
            </div>
        </div>
    </main>

    <!-- Receipt Modal -->
    <div id="receiptModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-xl p-8 max-w-lg w-full mx-4">
            <div class="flex justify-between items-start mb-6">
                <h2 class="text-2xl font-bold text-gray-900">Payment Receipt</h2>
                <button onclick="closeReceiptModal()" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div id="receiptContent" class="space-y-4">
                <!-- Receipt content will be inserted here -->
            </div>
            <div class="mt-8 flex justify-end space-x-4">
                <button onclick="downloadReceipt()" class="bg-brand-primary text-white px-6 py-3 rounded-lg hover:bg-brand-secondary transition-colors">
                    <i class="fas fa-download mr-2"></i>Download
                </button>
                <button onclick="closeReceiptModal()" class="bg-gray-100 text-gray-700 px-6 py-3 rounded-lg hover:bg-gray-200 transition-colors">
                    Close
                </button>
            </div>
        </div>
    </div>

    <script>
        // Initialize Supabase Client
        const supabaseUrl = 'https://fdgqqxyyofjnkhswkwcq.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZkZ3FxeHl5b2Zqbmtoc3drd2NxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDQwMjQyMTMsImV4cCI6MjA1OTYwMDIxM30.YyJLLu3r2a7Mh7ny0ie-YzzLfPh5PdrJJHnBFBxWqVE';
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

        // Pagination state
        let currentPage = 1;
        const itemsPerPage = 10;
        let totalPages = 1;

        // Format date
        function formatDate(dateString) {
            return new Date(dateString).toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // Format currency
        function formatCurrency(amount) {
            return `Rs. ${amount.toLocaleString()}`;
        }

        // Load user data
        async function loadUserData() {
            try {
                const { data: { user } } = await supabase.auth.getUser();
                if (!user) {
                    window.location.href = 'signin.html';
                    return;
                }

                document.getElementById('userName').textContent = user.email.split('@')[0];
                return user;
            } catch (error) {
                console.error('Error loading user data:', error);
                return null;
            }
        }

        // Load payment statistics
        async function loadStats(userId) {
            try {
                // Get all payments
                const { data: payments, error } = await supabase
                    .from('payments')
                    .select('amount, created_at')
                    .eq('user_id', userId);

                if (error) throw error;

                // Calculate total spent
                const totalSpent = payments.reduce((sum, payment) => sum + payment.amount, 0);
                document.getElementById('totalSpent').textContent = formatCurrency(totalSpent);

                // Calculate total transactions
                document.getElementById('totalTransactions').textContent = payments.length;

                // Calculate this month's spending
                const thisMonth = new Date().getMonth();
                const thisYear = new Date().getFullYear();
                const monthlySpent = payments
                    .filter(payment => {
                        const paymentDate = new Date(payment.created_at);
                        return paymentDate.getMonth() === thisMonth && 
                               paymentDate.getFullYear() === thisYear;
                    })
                    .reduce((sum, payment) => sum + payment.amount, 0);
                document.getElementById('monthlySpent').textContent = formatCurrency(monthlySpent);

            } catch (error) {
                console.error('Error loading payment stats:', error);
            }
        }

        // Load payments
        async function loadPayments(userId, page = 1, filters = {}) {
            try {
                let query = supabase
                    .from('payments')
                    .select(`
                        *,
                        unlocked_contacts (
                            type,
                            profiles:maid_id (*),
                            jobs:job_id (*)
                        )
                    `)
                    .eq('user_id', userId);

                // Apply status filter
                if (filters.status && filters.status !== 'all') {
                    query = query.eq('status', filters.status);
                }

                // Apply date filter
                if (filters.date && filters.date !== 'all') {
                    const now = new Date();
                    let startDate;
                    
                    switch (filters.date) {
                        case 'today':
                            startDate = new Date(now.setHours(0, 0, 0, 0));
                            break;
                        case 'week':
                            startDate = new Date(now.setDate(now.getDate() - 7));
                            break;
                        case 'month':
                            startDate = new Date(now.setMonth(now.getMonth() - 1));
                            break;
                        case 'year':
                            startDate = new Date(now.setFullYear(now.getFullYear() - 1));
                            break;
                    }
                    
                    query = query.gte('created_at', startDate.toISOString());
                }

                // Apply search filter
                if (filters.search) {
                    query = query.or(`payment_id.ilike.%${filters.search}%`);
                }

                // Get total count
                const { count } = await query.count();
                totalPages = Math.ceil(count / itemsPerPage);

                // Apply pagination
                const { data: payments, error } = await query
                    .order('created_at', { ascending: false })
                    .range((page - 1) * itemsPerPage, page * itemsPerPage - 1);

                if (error) throw error;

                if (!payments?.length) {
                    showEmptyState();
                    return;
                }

                const paymentsHtml = payments.map(payment => {
                    const contact = payment.unlocked_contacts[0];
                    const contactDetails = contact.type === 'maid' ? contact.profiles : contact.jobs;
                    const contactName = contact.type === 'maid' ? contactDetails.full_name : contactDetails.owner_name;

                    return `
                        <div class="payment-card">
                            <div class="flex items-center justify-between">
                                <div class="flex-1">
                                    <div class="flex items-center mb-2">
                                        <span class="text-lg font-semibold text-gray-900">${contactName}</span>
                                        <span class="mx-2 text-gray-400">â€¢</span>
                                        <span class="text-gray-600 capitalize">${contact.type} Contact</span>
                                    </div>
                                    <div class="text-sm text-gray-500">
                                        Transaction ID: ${payment.payment_id}
                                    </div>
                                </div>
                                <div class="text-right">
                                    <div class="text-lg font-bold text-gray-900">${formatCurrency(payment.amount)}</div>
                                    <div class="text-sm text-gray-500">${formatDate(payment.created_at)}</div>
                                </div>
                                <div class="ml-6 flex items-center space-x-4">
                                    <span class="status-badge ${payment.status}">${payment.status}</span>
                                    <button onclick="viewReceipt(${payment.id})" class="text-brand-primary hover:text-brand-secondary">
                                        <i class="fas fa-receipt"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');

                document.getElementById('paymentsContainer').innerHTML = paymentsHtml;
                updatePagination();
            } catch (error) {
                console.error('Error loading payments:', error);
                showError();
            }
        }

        // Show empty state
        function showEmptyState() {
            document.getElementById('paymentsContainer').classList.add('hidden');
            document.getElementById('emptyState').classList.remove('hidden');
            document.getElementById('pagination').classList.add('hidden');
        }

        // Show error
        function showError() {
            document.getElementById('paymentsContainer').innerHTML = `
                <div class="text-center py-8">
                    <div class="text-red-600 mb-2">Error loading payments</div>
                    <button onclick="window.location.reload()" class="text-brand-primary hover:text-brand-secondary">
                        Try Again
                    </button>
                </div>
            `;
            document.getElementById('pagination').classList.add('hidden');
        }

        // Update pagination
        function updatePagination() {
            const pagination = document.getElementById('pagination');
            const pageNumbers = document.getElementById('pageNumbers');
            const prevButton = document.getElementById('prevPage');
            const nextButton = document.getElementById('nextPage');

            if (totalPages <= 1) {
                pagination.classList.add('hidden');
                return;
            }

            pagination.classList.remove('hidden');
            prevButton.disabled = currentPage === 1;
            nextButton.disabled = currentPage === totalPages;

            let pagesHtml = '';
            for (let i = 1; i <= totalPages; i++) {
                pagesHtml += `
                    <button class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 
                                 ${currentPage === i ? 'bg-brand-light text-brand-primary font-semibold' : ''}"
                            onclick="goToPage(${i})">
                        ${i}
                    </button>
                `;
            }
            pageNumbers.innerHTML = pagesHtml;
        }

        // View receipt
        async function viewReceipt(paymentId) {
            try {
                const { data: payment, error } = await supabase
                    .from('payments')
                    .select(`
                        *,
                        unlocked_contacts (
                            type,
                            profiles:maid_id (*),
                            jobs:job_id (*)
                        )
                    `)
                    .eq('id', paymentId)
                    .single();

                if (error) throw error;

                const contact = payment.unlocked_contacts[0];
                const contactDetails = contact.type === 'maid' ? contact.profiles : contact.jobs;
                const contactName = contact.type === 'maid' ? contactDetails.full_name : contactDetails.owner_name;

                document.getElementById('receiptContent').innerHTML = `
                    <div class="border-b pb-4">
                        <div class="text-center mb-4">
                            <h3 class="text-xl font-bold text-gray-900">CityMaid</h3>
                            <p class="text-gray-600">Payment Receipt</p>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <p class="text-sm text-gray-500">Transaction ID</p>
                                <p class="font-medium">${payment.payment_id}</p>
                            </div>
                            <div class="text-right">
                                <p class="text-sm text-gray-500">Date</p>
                                <p class="font-medium">${formatDate(payment.created_at)}</p>
                            </div>
                        </div>
                    </div>
                    <div class="py-4">
                        <h4 class="font-semibold mb-2">Payment Details</h4>
                        <div class="space-y-2">
                            <div class="flex justify-between">
                                <span class="text-gray-600">Contact Type</span>
                                <span class="font-medium capitalize">${contact.type}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">Contact Name</span>
                                <span class="font-medium">${contactName}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">Amount</span>
                                <span class="font-medium">${formatCurrency(payment.amount)}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">Status</span>
                                <span class="status-badge ${payment.status}">${payment.status}</span>
                            </div>
                        </div>
                    </div>
                `;

                document.getElementById('receiptModal').classList.remove('hidden');
            } catch (error) {
                console.error('Error loading receipt:', error);
                alert('Failed to load receipt. Please try again.');
            }
        }

        // Close receipt modal
        function closeReceiptModal() {
            document.getElementById('receiptModal').classList.add('hidden');
        }

        // Download receipt
        function downloadReceipt() {
            const receiptContent = document.getElementById('receiptContent').innerText;
            const blob = new Blob([receiptContent], { type: 'text/plain' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `citymaid-receipt-${Date.now()}.txt`;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
        }

        // Export payments
        async function exportPayments() {
            const user = await loadUserData();
            if (!user) return;

            try {
                const { data: payments, error } = await supabase
                    .from('payments')
                    .select(`
                        *,
                        unlocked_contacts (
                            type,
                            profiles:maid_id (*),
                            jobs:job_id (*)
                        )
                    `)
                    .eq('user_id', user.id);

                if (error) throw error;

                if (!payments?.length) {
                    alert('No payments to export');
                    return;
                }

                // Format payments for CSV
                const csvData = payments.map(payment => {
                    const contact = payment.unlocked_contacts[0];
                    const contactDetails = contact.type === 'maid' ? contact.profiles : contact.jobs;
                    return {
                        'Transaction ID': payment.payment_id,
                        'Date': formatDate(payment.created_at),
                        'Amount': payment.amount,
                        'Status': payment.status,
                        'Contact Type': contact.type,
                        'Contact Name': contact.type === 'maid' ? contactDetails.full_name : contactDetails.owner_name
                    };
                });

                // Convert to CSV
                const csv = [
                    Object.keys(csvData[0]).join(','),
                    ...csvData.map(row => Object.values(row).join(','))
                ].join('\n');

                // Download CSV
                const blob = new Blob([csv], { type: 'text/csv' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'citymaid-payments.csv';
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);

            } catch (error) {
                console.error('Error exporting payments:', error);
                alert('Failed to export payments. Please try again.');
            }
        }

        // Go to specific page
        function goToPage(page) {
            currentPage = page;
            const filters = {
                status: document.getElementById('statusFilter').value,
                date: document.getElementById('dateFilter').value,
                search: document.getElementById('searchInput').value
            };
            loadPayments(currentUser.id, currentPage, filters);
        }

        // Event Listeners
        let currentUser = null;
        document.addEventListener('DOMContentLoaded', async () => {
            currentUser = await loadUserData();
            if (currentUser) {
                await loadStats(currentUser.id);
                await loadPayments(currentUser.id);
            }
        });

        // Search input
        let searchTimeout;
        document.getElementById('searchInput').addEventListener('input', (e) => {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                currentPage = 1;
                const filters = {
                    status: document.getElementById('statusFilter').value,
                    date: document.getElementById('dateFilter').value,
                    search: e.target.value
                };
                loadPayments(currentUser.id, currentPage, filters);
            }, 300);
        });

        // Filters
        document.getElementById('statusFilter').addEventListener('change', (e) => {
            currentPage = 1;
            const filters = {
                status: e.target.value,
                date: document.getElementById('dateFilter').value,
                search: document.getElementById('searchInput').value
            };
            loadPayments(currentUser.id, currentPage, filters);
        });

        document.getElementById('dateFilter').addEventListener('change', (e) => {
            currentPage = 1;
            const filters = {
                status: document.getElementById('statusFilter').value,
                date: e.target.value,
                search: document.getElementById('searchInput').value
            };
            loadPayments(currentUser.id, currentPage, filters);
        });

        // Export button
        document.getElementById('exportBtn').addEventListener('click', exportPayments);

        // Pagination buttons
        document.getElementById('prevPage').addEventListener('click', () => {
            if (currentPage > 1) {
                goToPage(currentPage - 1);
            }
        });

        document.getElementById('nextPage').addEventListener('click', () => {
            if (currentPage < totalPages) {
                goToPage(currentPage + 1);
            }
        });

        // Close modal when clicking outside
        document.getElementById('receiptModal').addEventListener('click', (e) => {
            if (e.target === document.getElementById('receiptModal')) {
                closeReceiptModal();
            }
        });
    </script>
</body>
</html>