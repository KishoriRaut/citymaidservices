<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Payments - CityMaid</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        .payment-card {
            @apply bg-white rounded-xl p-6 border border-gray-100 hover:shadow-lg transition-all duration-300;
        }
        .status-badge {
            @apply px-3 py-1 rounded-full text-sm font-medium;
        }
        .status-badge.completed {
            @apply bg-green-100 text-green-800;
        }
        .status-badge.pending {
            @apply bg-yellow-100 text-yellow-800;
        }
        .status-badge.failed {
            @apply bg-red-100 text-red-800;
        }
        .tab-button {
            @apply px-6 py-3 text-gray-600 hover:text-indigo-600 border-b-2 border-transparent;
        }
        .tab-button.active {
            @apply text-indigo-600 border-indigo-600 font-medium;
        }
    </style>
</head>
<body class="bg-gray-50 font-poppins">
    <!-- Navigation -->
    <nav class="bg-white shadow-sm">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <a href="index.html" class="text-2xl font-bold text-indigo-600">CityMaid</a>
                </div>
                <div class="flex items-center space-x-4">
                    <a href="dashboard.html" class="text-gray-600 hover:text-indigo-600">
                        <i class="fas fa-arrow-left mr-2"></i>Back to Dashboard
                    </a>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Header -->
        <div class="mb-8">
            <h1 class="text-3xl font-bold text-gray-900">Payments & Unlocked Contacts</h1>
            <p class="text-gray-600 mt-2">Manage your payments and view unlocked contact information</p>
        </div>

        <!-- Stats Grid -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <!-- Total Spent -->
            <div class="bg-white rounded-xl p-6 border border-gray-100">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm text-gray-500">Total Spent</p>
                        <h3 class="text-2xl font-bold text-gray-900 mt-1" id="totalSpent">Rs. 0</h3>
                    </div>
                    <div class="w-12 h-12 bg-indigo-100 rounded-full flex items-center justify-center">
                        <i class="fas fa-wallet text-xl text-indigo-600"></i>
                    </div>
                </div>
            </div>

            <!-- Unlocked Contacts -->
            <div class="bg-white rounded-xl p-6 border border-gray-100">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm text-gray-500">Unlocked Contacts</p>
                        <h3 class="text-2xl font-bold text-gray-900 mt-1" id="unlockedCount">0</h3>
                    </div>
                    <div class="w-12 h-12 bg-indigo-100 rounded-full flex items-center justify-center">
                        <i class="fas fa-unlock text-xl text-indigo-600"></i>
                    </div>
                </div>
            </div>

            <!-- Last Payment -->
            <div class="bg-white rounded-xl p-6 border border-gray-100">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm text-gray-500">Last Payment</p>
                        <h3 class="text-2xl font-bold text-gray-900 mt-1" id="lastPayment">-</h3>
                    </div>
                    <div class="w-12 h-12 bg-indigo-100 rounded-full flex items-center justify-center">
                        <i class="fas fa-clock text-xl text-indigo-600"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tabs -->
        <div class="border-b border-gray-200 mb-8">
            <div class="flex space-x-8">
                <button class="tab-button active" data-tab="payments">
                    <i class="fas fa-credit-card mr-2"></i>Payment History
                </button>
                <button class="tab-button" data-tab="contacts">
                    <i class="fas fa-address-book mr-2"></i>Unlocked Contacts
                </button>
            </div>
        </div>

        <!-- Tab Content -->
        <div id="tabContent">
            <!-- Payments Tab -->
            <div id="paymentsTab" class="space-y-6">
                <!-- Actions -->
                <div class="flex justify-between items-center">
                    <div class="flex space-x-4">
                        <select id="filterStatus" class="border border-gray-300 rounded-lg px-4 py-2 text-gray-700">
                            <option value="">All Status</option>
                            <option value="completed">Completed</option>
                            <option value="pending">Pending</option>
                            <option value="failed">Failed</option>
                        </select>
                        <select id="filterType" class="border border-gray-300 rounded-lg px-4 py-2 text-gray-700">
                            <option value="">All Types</option>
                            <option value="maid">Maid Contact</option>
                            <option value="job">Job Contact</option>
                        </select>
                    </div>
                    <button onclick="exportPayments()" class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700">
                        <i class="fas fa-download mr-2"></i>Export
                    </button>
                </div>

                <!-- Payments List -->
                <div id="paymentsList" class="space-y-4">
                    <!-- Payments will be loaded here -->
                </div>
            </div>

            <!-- Contacts Tab -->
            <div id="contactsTab" class="hidden space-y-6">
                <!-- Actions -->
                <div class="flex justify-between items-center">
                    <div class="flex space-x-4">
                        <select id="filterContactType" class="border border-gray-300 rounded-lg px-4 py-2 text-gray-700">
                            <option value="">All Types</option>
                            <option value="maid">Maids</option>
                            <option value="job">Jobs</option>
                        </select>
                    </div>
                    <button onclick="exportContacts()" class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700">
                        <i class="fas fa-download mr-2"></i>Export
                    </button>
                </div>

                <!-- Contacts List -->
                <div id="contactsList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- Contacts will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Receipt Modal -->
    <div id="receiptModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-xl p-8 max-w-md w-full mx-4">
            <div id="receiptContent">
                <!-- Receipt content will be loaded here -->
            </div>
            <div class="mt-6 flex justify-between">
                <button onclick="downloadReceipt()" class="text-indigo-600 hover:text-indigo-700">
                    <i class="fas fa-download mr-1"></i>Download
                </button>
                <button onclick="closeReceiptModal()" class="text-gray-600 hover:text-gray-800">
                    Close
                </button>
            </div>
        </div>
    </div>

    <script>
        // Initialize Supabase
        const supabaseUrl = 'https://fdgqqxyyofjnkhswkwcq.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZkZ3FxeHl5b2Zqbmtoc3drd2NxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDQwMjQyMTMsImV4cCI6MjA1OTYwMDIxM30.YyJLLu3r2a7Mh7ny0ie-YzzLfPh5PdrJJHnBFBxWqVE';
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

        // Format currency
        function formatCurrency(amount) {
            return new Intl.NumberFormat('en-NP', {
                style: 'currency',
                currency: 'NPR',
                maximumFractionDigits: 0
            }).format(amount);
        }

        // Format date
        function formatDate(dateString) {
            return new Date(dateString).toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });
        }

        // Load page data
        async function loadPageData() {
            try {
                const { data: { user } } = await supabase.auth.getUser();
                if (!user) {
                    window.location.href = 'signin.html';
                    return;
                }

                // Load payments
                const { data: payments, error: paymentsError } = await supabase
                    .from('payments')
                    .select(`
                        *,
                        unlocked_contacts (
                            *,
                            profiles (*),
                            jobs (*)
                        )
                    `)
                    .eq('user_id', user.id)
                    .order('created_at', { ascending: false });

                if (paymentsError) throw paymentsError;

                // Update stats
                updateStats(payments);

                // Display payments
                displayPayments(payments);

                // Load contacts
                const { data: contacts, error: contactsError } = await supabase
                    .from('unlocked_contacts')
                    .select(`
                        *,
                        profiles (*),
                        jobs (*)
                    `)
                    .eq('user_id', user.id)
                    .order('created_at', { ascending: false });

                if (contactsError) throw contactsError;

                // Display contacts
                displayContacts(contacts);

            } catch (error) {
                console.error('Error loading page data:', error);
                alert('Failed to load data. Please refresh the page.');
            }
        }

        // Update stats
        function updateStats(payments) {
            const totalSpent = payments.reduce((sum, payment) => sum + payment.amount, 0);
            document.getElementById('totalSpent').textContent = formatCurrency(totalSpent);
            document.getElementById('unlockedCount').textContent = payments.length;
            document.getElementById('lastPayment').textContent = payments.length ? 
                formatDate(payments[0].created_at) : '-';
        }

        // Display payments
        function displayPayments(payments) {
            const paymentsList = document.getElementById('paymentsList');
            
            if (!payments?.length) {
                paymentsList.innerHTML = `
                    <div class="text-center py-12">
                        <i class="fas fa-credit-card text-4xl text-gray-400 mb-4"></i>
                        <p class="text-gray-500">No payments found</p>
                    </div>
                `;
                return;
            }

            paymentsList.innerHTML = payments.map(payment => {
                const contact = payment.unlocked_contacts[0];
                const contactDetails = contact.type === 'maid' ? contact.profiles : contact.jobs;
                const contactName = contact.type === 'maid' ? contactDetails.full_name : contactDetails.owner_name;

                return `
                    <div class="payment-card">
                        <div class="flex items-center justify-between">
                            <div class="flex-1">
                                <div class="flex items-center mb-2">
                                    <span class="text-lg font-semibold text-gray-900">${contactName}</span>
                                    <span class="mx-2 text-gray-400">â€¢</span>
                                    <span class="text-gray-600 capitalize">${contact.type} Contact</span>
                                </div>
                                <div class="text-sm text-gray-500">
                                    Transaction ID: ${payment.payment_id}
                                </div>
                            </div>
                            <div class="text-right">
                                <div class="text-lg font-bold text-gray-900">${formatCurrency(payment.amount)}</div>
                                <div class="text-sm text-gray-500">${formatDate(payment.created_at)}</div>
                            </div>
                        </div>
                        <div class="flex items-center justify-between mt-4 pt-4 border-t border-gray-100">
                            <div>
                                <span class="status-badge ${payment.status}">${payment.status}</span>
                            </div>
                            <button onclick="viewReceipt('${payment.id}')" class="text-indigo-600 hover:text-indigo-700">
                                <i class="fas fa-receipt mr-1"></i>View Receipt
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Display contacts
        function displayContacts(contacts) {
            const contactsList = document.getElementById('contactsList');
            
            if (!contacts?.length) {
                contactsList.innerHTML = `
                    <div class="col-span-full text-center py-12">
                        <i class="fas fa-address-book text-4xl text-gray-400 mb-4"></i>
                        <p class="text-gray-500">No unlocked contacts found</p>
                    </div>
                `;
                return;
            }

            contactsList.innerHTML = contacts.map(contact => {
                const details = contact.type === 'maid' ? contact.profiles : contact.jobs;
                const name = contact.type === 'maid' ? details.full_name : details.owner_name;
                const location = details.location;
                const phone = contact.type === 'maid' ? details.contact_phone : details.contact_phone;
                const email = contact.type === 'maid' ? details.contact_email : details.contact_email;

                return `
                    <div class="bg-white rounded-xl p-6 border border-gray-100">
                        <div class="flex items-start justify-between mb-4">
                            <div>
                                <h3 class="text-lg font-semibold text-gray-900">${name}</h3>
                                <p class="text-gray-600">${location}</p>
                            </div>
                            <span class="capitalize text-sm font-medium text-indigo-600 bg-indigo-50 px-3 py-1 rounded-full">
                                ${contact.type}
                            </span>
                        </div>
                        <div class="space-y-3">
                            <div class="flex items-center text-gray-600">
                                <i class="fas fa-phone-alt w-5"></i>
                                <span class="ml-2">${phone}</span>
                            </div>
                            <div class="flex items-center text-gray-600">
                                <i class="fas fa-envelope w-5"></i>
                                <span class="ml-2">${email}</span>
                            </div>
                        </div>
                        <div class="mt-4 pt-4 border-t border-gray-100 text-sm text-gray-500">
                            Unlocked on ${formatDate(contact.created_at)}
                        </div>
                    </div>
                `;
            }).join('');
        }

        // View receipt
        async function viewReceipt(paymentId) {
            try {
                const { data: payment, error } = await supabase
                    .from('payments')
                    .select(`
                        *,
                        unlocked_contacts (
                            *,
                            profiles (*),
                            jobs (*)
                        )
                    `)
                    .eq('id', paymentId)
                    .single();

                if (error) throw error;

                const contact = payment.unlocked_contacts[0];
                const contactDetails = contact.type === 'maid' ? contact.profiles : contact.jobs;
                const contactName = contact.type === 'maid' ? contactDetails.full_name : contactDetails.owner_name;

                document.getElementById('receiptContent').innerHTML = `
                    <div class="border-b pb-4">
                        <div class="text-center mb-4">
                            <h3 class="text-xl font-bold text-gray-900">CityMaid</h3>
                            <p class="text-gray-600">Payment Receipt</p>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <p class="text-sm text-gray-500">Transaction ID</p>
                                <p class="font-medium">${payment.payment_id}</p>
                            </div>
                            <div class="text-right">
                                <p class="text-sm text-gray-500">Date</p>
                                <p class="font-medium">${formatDate(payment.created_at)}</p>
                            </div>
                        </div>
                    </div>
                    <div class="py-4">
                        <h4 class="font-semibold mb-2">Payment Details</h4>
                        <div class="space-y-2">
                            <div class="flex justify-between">
                                <span class="text-gray-600">Contact Type</span>
                                <span class="font-medium capitalize">${contact.type}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">Contact Name</span>
                                <span class="font-medium">${contactName}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">Amount</span>
                                <span class="font-medium">${formatCurrency(payment.amount)}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">Status</span>
                                <span class="status-badge ${payment.status}">${payment.status}</span>
                            </div>
                        </div>
                    </div>
                `;

                document.getElementById('receiptModal').classList.remove('hidden');
            } catch (error) {
                console.error('Error loading receipt:', error);
                alert('Failed to load receipt. Please try again.');
            }
        }

        // Close receipt modal
        function closeReceiptModal() {
            document.getElementById('receiptModal').classList.add('hidden');
        }

        // Download receipt
        function downloadReceipt() {
            const receiptContent = document.getElementById('receiptContent');
            const printWindow = window.open('', '', 'width=800,height=600');
            printWindow.document.write(`
                <html>
                    <head>
                        <title>CityMaid Payment Receipt</title>
                        <style>
                            body { font-family: Arial, sans-serif; padding: 20px; }
                            .receipt { max-width: 600px; margin: 0 auto; }
                        </style>
                    </head>
                    <body>
                        <div class="receipt">
                            ${receiptContent.innerHTML}
                        </div>
                    </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
        }

        // Export payments
        async function exportPayments() {
            try {
                const { data: payments, error } = await supabase
                    .from('payments')
                    .select(`
                        *,
                        unlocked_contacts (
                            *,
                            profiles (*),
                            jobs (*)
                        )
                    `)
                    .eq('user_id', (await supabase.auth.getUser()).data.user.id)
                    .order('created_at', { ascending: false });

                if (error) throw error;

                // Format payments for CSV
                const csvData = payments.map(payment => {
                    const contact = payment.unlocked_contacts[0];
                    const contactDetails = contact.type === 'maid' ? contact.profiles : contact.jobs;
                    return {
                        'Transaction ID': payment.payment_id,
                        'Date': formatDate(payment.created_at),
                        'Amount': payment.amount,
                        'Status': payment.status,
                        'Contact Type': contact.type,
                        'Contact Name': contact.type === 'maid' ? contactDetails.full_name : contactDetails.owner_name
                    };
                });

                // Download CSV
                downloadCSV(csvData, 'citymaid-payments.csv');

            } catch (error) {
                console.error('Error exporting payments:', error);
                alert('Failed to export payments. Please try again.');
            }
        }

        // Export contacts
        async function exportContacts() {
            try {
                const { data: contacts, error } = await supabase
                    .from('unlocked_contacts')
                    .select(`
                        *,
                        profiles (*),
                        jobs (*)
                    `)
                    .eq('user_id', (await supabase.auth.getUser()).data.user.id)
                    .order('created_at', { ascending: false });

                if (error) throw error;

                // Format contacts for CSV
                const csvData = contacts.map(contact => {
                    const details = contact.type === 'maid' ? contact.profiles : contact.jobs;
                    return {
                        'Name': contact.type === 'maid' ? details.full_name : details.owner_name,
                        'Type': contact.type,
                        'Location': details.location,
                        'Phone': contact.type === 'maid' ? details.contact_phone : details.contact_phone,
                        'Email': contact.type === 'maid' ? details.contact_email : details.contact_email,
                        'Unlocked On': formatDate(contact.created_at)
                    };
                });

                // Download CSV
                downloadCSV(csvData, 'citymaid-contacts.csv');

            } catch (error) {
                console.error('Error exporting contacts:', error);
                alert('Failed to export contacts. Please try again.');
            }
        }

        // Download CSV helper
        function downloadCSV(data, filename) {
            const csv = [
                Object.keys(data[0]).join(','),
                ...data.map(row => Object.values(row).join(','))
            ].join('\n');

            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
        }

        // Tab switching
        document.querySelectorAll('.tab-button').forEach(button => {
            button.addEventListener('click', () => {
                // Update button states
                document.querySelectorAll('.tab-button').forEach(btn => {
                    btn.classList.remove('active');
                });
                button.classList.add('active');

                // Show correct tab
                const tabId = button.dataset.tab;
                document.querySelectorAll('#tabContent > div').forEach(tab => {
                    tab.classList.add('hidden');
                });
                document.getElementById(`${tabId}Tab`).classList.remove('hidden');
            });
        });

        // Filter handling
        document.getElementById('filterStatus').addEventListener('change', async () => {
            const status = document.getElementById('filterStatus').value;
            const type = document.getElementById('filterType').value;
            await loadFilteredPayments(status, type);
        });

        document.getElementById('filterType').addEventListener('change', async () => {
            const status = document.getElementById('filterStatus').value;
            const type = document.getElementById('filterType').value;
            await loadFilteredPayments(status, type);
        });

        document.getElementById('filterContactType').addEventListener('change', async () => {
            const type = document.getElementById('filterContactType').value;
            await loadFilteredContacts(type);
        });

        // Load filtered payments
        async function loadFilteredPayments(status, type) {
            try {
                let query = supabase
                    .from('payments')
                    .select(`
                        *,
                        unlocked_contacts (
                            *,
                            profiles (*),
                            jobs (*)
                        )
                    `)
                    .eq('user_id', (await supabase.auth.getUser()).data.user.id);

                if (status) {
                    query = query.eq('status', status);
                }
                if (type) {
                    query = query.eq('unlocked_contacts.type', type);
                }

                const { data: payments, error } = await query.order('created_at', { ascending: false });

                if (error) throw error;
                displayPayments(payments);

            } catch (error) {
                console.error('Error filtering payments:', error);
                alert('Failed to filter payments. Please try again.');
            }
        }

        // Load filtered contacts
        async function loadFilteredContacts(type) {
            try {
                let query = supabase
                    .from('unlocked_contacts')
                    .select(`
                        *,
                        profiles (*),
                        jobs (*)
                    `)
                    .eq('user_id', (await supabase.auth.getUser()).data.user.id);

                if (type) {
                    query = query.eq('type', type);
                }

                const { data: contacts, error } = await query.order('created_at', { ascending: false });

                if (error) throw error;
                displayContacts(contacts);

            } catch (error) {
                console.error('Error filtering contacts:', error);
                alert('Failed to filter contacts. Please try again.');
            }
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', loadPageData);
    </script>
</body>
</html>