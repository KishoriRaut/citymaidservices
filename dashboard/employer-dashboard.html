<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Employer Dashboard - CityMaid</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        .dashboard-card {
            @apply bg-white rounded-xl shadow-md p-6 hover:shadow-lg transition-all duration-300;
        }
        .stat-card {
            @apply bg-gradient-to-br from-indigo-600 to-indigo-700 text-white rounded-xl p-6 relative overflow-hidden;
        }
        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M11 18c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm48 25c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm-43-7c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm63 31c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM34 90c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm56-76c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM12 86c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm28-65c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm23-11c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-6 60c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm29 22c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zM32 63c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm57-13c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5z' fill='%23ffffff' fill-opacity='0.1'/%3E%3C/svg%3E");
            opacity: 0.1;
        }
        .tab-button {
            @apply px-4 py-2 text-gray-600 hover:text-indigo-600 border-b-2 border-transparent;
        }
        .tab-button.active {
            @apply text-indigo-600 border-indigo-600;
        }
        .contact-card {
            @apply bg-white rounded-lg p-4 border border-gray-100 hover:border-indigo-100 transition-all duration-300;
        }
    </style>
</head>
<body class="bg-gray-50 font-poppins">
    <!-- Top Navigation -->
    <nav class="bg-white shadow-sm sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <a href="index.html" class="text-2xl font-bold text-indigo-600">CityMaid</a>
                </div>
                <div class="flex items-center space-x-4">
                    <button id="notificationBtn" class="p-2 text-gray-500 hover:text-indigo-600 relative">
                        <i class="fas fa-bell"></i>
                        <span class="absolute top-0 right-0 h-2 w-2 bg-red-500 rounded-full"></span>
                    </button>
                    <div class="relative" id="userDropdown">
                        <button class="flex items-center space-x-2 text-gray-700 hover:text-indigo-600">
                            <img id="userAvatar" src="https://via.placeholder.com/32" class="w-8 h-8 rounded-full">
                            <span id="userName">Loading...</span>
                            <i class="fas fa-chevron-down text-sm"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Welcome Section -->
        <div class="bg-gradient-to-r from-indigo-600 to-indigo-800 rounded-2xl p-8 mb-8 text-white">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-3xl font-bold mb-2">Welcome Back, <span id="welcomeName">Employer</span>!</h1>
                    <p class="opacity-90">Manage your job posts and track your unlocked contacts</p>
                </div>
                <button onclick="window.location.href='post-job.html'" class="bg-white text-indigo-600 px-6 py-2 rounded-lg hover:bg-indigo-50 transition-colors">
                    <i class="fas fa-plus mr-2"></i>Post New Job
                </button>
            </div>
        </div>

        <!-- Stats Grid -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <!-- Active Jobs -->
            <div class="stat-card">
                <div class="flex justify-between items-start">
                    <div>
                        <p class="text-sm opacity-75">Active Jobs</p>
                        <h3 class="text-2xl font-bold mt-1" id="activeJobsCount">0</h3>
                    </div>
                    <div class="w-10 h-10 rounded-full bg-white/10 flex items-center justify-center">
                        <i class="fas fa-briefcase text-xl"></i>
                    </div>
                </div>
            </div>

            <!-- Unlocked Contacts -->
            <div class="stat-card">
                <div class="flex justify-between items-start">
                    <div>
                        <p class="text-sm opacity-75">Unlocked Contacts</p>
                        <h3 class="text-2xl font-bold mt-1" id="unlockedContactsCount">0</h3>
                    </div>
                    <div class="w-10 h-10 rounded-full bg-white/10 flex items-center justify-center">
                        <i class="fas fa-user-check text-xl"></i>
                    </div>
                </div>
            </div>

            <!-- Total Spent -->
            <div class="stat-card">
                <div class="flex justify-between items-start">
                    <div>
                        <p class="text-sm opacity-75">Total Spent</p>
                        <h3 class="text-2xl font-bold mt-1" id="totalSpent">NPR 0</h3>
                    </div>
                    <div class="w-10 h-10 rounded-full bg-white/10 flex items-center justify-center">
                        <i class="fas fa-wallet text-xl"></i>
                    </div>
                </div>
            </div>

            <!-- This Month -->
            <div class="stat-card">
                <div class="flex justify-between items-start">
                    <div>
                        <p class="text-sm opacity-75">This Month</p>
                        <h3 class="text-2xl font-bold mt-1" id="monthlySpent">NPR 0</h3>
                    </div>
                    <div class="w-10 h-10 rounded-full bg-white/10 flex items-center justify-center">
                        <i class="fas fa-calendar text-xl"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Grid -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Left Column (2 cols) -->
            <div class="lg:col-span-2 space-y-8">
                <!-- My Job Posts -->
                <div class="dashboard-card">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-xl font-bold text-gray-800">My Job Posts</h2>
                        <button onclick="window.location.href='post-job.html'" class="text-indigo-600 hover:text-indigo-700">
                            <i class="fas fa-plus mr-1"></i>New Post
                        </button>
                    </div>
                    <div id="jobPostsList" class="space-y-4">
                        <!-- Job posts will be loaded here -->
                    </div>
                </div>

                <!-- Unlocked Contacts -->
                <div class="dashboard-card">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-xl font-bold text-gray-800">Unlocked Contacts</h2>
                        <button onclick="exportContacts()" class="text-indigo-600 hover:text-indigo-700">
                            <i class="fas fa-download mr-1"></i>Export
                        </button>
                    </div>
                    <div id="unlockedContactsList" class="space-y-4">
                        <!-- Unlocked contacts will be loaded here -->
                    </div>
                </div>
            </div>

            <!-- Right Column -->
            <div class="space-y-8">
                <!-- Quick Actions -->
                <div class="dashboard-card">
                    <h2 class="text-xl font-bold text-gray-800 mb-4">Quick Actions</h2>
                    <div class="space-y-3">
                        <button onclick="window.location.href='find-maids.html'" class="w-full bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 transition-colors">
                            <i class="fas fa-search mr-2"></i>Find Maids
                        </button>
                        <button onclick="window.location.href='post-job.html'" class="w-full bg-white text-indigo-600 px-4 py-2 rounded-lg border-2 border-indigo-600 hover:bg-indigo-50 transition-colors">
                            <i class="fas fa-plus mr-2"></i>Post New Job
                        </button>
                    </div>
                </div>

                <!-- Recent Payments -->
                <div class="dashboard-card">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-xl font-bold text-gray-800">Recent Payments</h2>
                        <button onclick="window.location.href='payment-history.html'" class="text-indigo-600 hover:text-indigo-700 text-sm">
                            View All
                        </button>
                    </div>
                    <div id="recentPaymentsList" class="space-y-4">
                        <!-- Recent payments will be loaded here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Initialize Supabase
        const supabaseUrl = 'https://fdgqqxyyofjnkhswkwcq.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZkZ3FxeHl5b2Zqbmtoc3drd2NxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDQwMjQyMTMsImV4cCI6MjA1OTYwMDIxM30.YyJLLu3r2a7Mh7ny0ie-YzzLfPh5PdrJJHnBFBxWqVE';
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

        // Format currency
        function formatCurrency(amount) {
            return new Intl.NumberFormat('en-NP', {
                style: 'currency',
                currency: 'NPR',
                maximumFractionDigits: 0
            }).format(amount);
        }

        // Format date
        function formatDate(dateString) {
            return new Date(dateString).toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });
        }

        // Load dashboard data
        async function loadDashboardData() {
            try {
                const { data: { user } } = await supabase.auth.getUser();
                if (!user) {
                    window.location.href = 'signin.html';
                    return;
                }

                // Update user name
                const userName = user.email.split('@')[0];
                document.getElementById('userName').textContent = userName;
                document.getElementById('welcomeName').textContent = userName;

                // Load stats
                await loadStats(user.id);

                // Load job posts
                await loadJobPosts(user.id);

                // Load unlocked contacts
                await loadUnlockedContacts(user.id);

                // Load recent payments
                await loadRecentPayments(user.id);

            } catch (error) {
                console.error('Error loading dashboard:', error);
            }
        }

        // Load stats
        async function loadStats(userId) {
            try {
                // Get active jobs count
                const { data: jobs, error: jobsError } = await supabase
                    .from('jobs')
                    .select('id')
                    .eq('user_id', userId)
                    .eq('is_active', true);

                // Get unlocked contacts count
                const { data: contacts, error: contactsError } = await supabase
                    .from('unlocked_contacts')
                    .select('id')
                    .eq('user_id', userId);

                // Get total spent
                const { data: payments, error: paymentsError } = await supabase
                    .from('payments')
                    .select('amount')
                    .eq('user_id', userId);

                // Calculate monthly spent
                const thisMonth = new Date().getMonth();
                const thisYear = new Date().getFullYear();
                const monthlySpent = payments
                    .filter(payment => {
                        const paymentDate = new Date(payment.created_at);
                        return paymentDate.getMonth() === thisMonth && 
                               paymentDate.getFullYear() === thisYear;
                    })
                    .reduce((sum, payment) => sum + payment.amount, 0);

                // Update stats
                document.getElementById('activeJobsCount').textContent = jobs?.length || 0;
                document.getElementById('unlockedContactsCount').textContent = contacts?.length || 0;
                document.getElementById('totalSpent').textContent = formatCurrency(
                    payments?.reduce((sum, payment) => sum + payment.amount, 0) || 0
                );
                document.getElementById('monthlySpent').textContent = formatCurrency(monthlySpent);

            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }

        // Load job posts
        async function loadJobPosts(userId) {
            try {
                const { data: jobs, error } = await supabase
                    .from('jobs')
                    .select('*')
                    .eq('user_id', userId)
                    .order('created_at', { ascending: false })
                    .limit(5);

                if (error) throw error;

                const jobsList = document.getElementById('jobPostsList');
                if (!jobs?.length) {
                    jobsList.innerHTML = `
                        <div class="text-center py-8 text-gray-500">
                            <i class="fas fa-briefcase text-4xl mb-2"></i>
                            <p>No job posts yet</p>
                            <button onclick="window.location.href='post-job.html'" 
                                    class="text-indigo-600 hover:text-indigo-700 mt-2">
                                Post Your First Job
                            </button>
                        </div>
                    `;
                    return;
                }

                jobsList.innerHTML = jobs.map(job => `
                    <div class="flex items-center justify-between p-4 border border-gray-100 rounded-lg hover:border-indigo-100 transition-all">
                        <div>
                            <h3 class="font-medium text-gray-900">${job.owner_name}</h3>
                            <div class="text-sm text-gray-500 mt-1">
                                <span><i class="fas fa-map-marker-alt mr-1"></i>${job.location}</span>
                                <span class="mx-2">•</span>
                                <span><i class="fas fa-clock mr-1"></i>${job.working_hours}</span>
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="text-sm font-medium ${job.is_active ? 'text-green-600' : 'text-gray-500'}">
                                ${job.is_active ? 'Active' : 'Inactive'}
                            </div>
                            <div class="text-sm text-gray-500">
                                Posted ${formatDate(job.created_at)}
                            </div>
                        </div>
                    </div>
                `).join('');

            } catch (error) {
                console.error('Error loading job posts:', error);
            }
        }

        // Load unlocked contacts
        async function loadUnlockedContacts(userId) {
            try {
                const { data: contacts, error } = await supabase
                    .from('unlocked_contacts')
                    .select(`
                        *,
                        profiles:maid_id (*)
                    `)
                    .eq('user_id', userId)
                    .order('created_at', { ascending: false })
                    .limit(5);

                if (error) throw error;

                const contactsList = document.getElementById('unlockedContactsList');
                if (!contacts?.length) {
                    contactsList.innerHTML = `
                        <div class="text-center py-8 text-gray-500">
                            <i class="fas fa-user-check text-4xl mb-2"></i>
                            <p>No unlocked contacts yet</p>
                            <button onclick="window.location.href='find-maids.html'" 
                                    class="text-indigo-600 hover:text-indigo-700 mt-2">
                                Find Maids
                            </button>
                        </div>
                    `;
                    return;
                }

                contactsList.innerHTML = contacts.map(contact => `
                    <div class="contact-card">
                        <div class="flex items-center justify-between">
                            <div>
                                <h3 class="font-medium text-gray-900">${contact.profiles.full_name}</h3>
                                <div class="text-sm text-gray-500 mt-1">
                                    <a href="tel:${contact.profiles.contact_phone}" class="hover:text-indigo-600">
                                        <i class="fas fa-phone mr-1"></i>${contact.profiles.contact_phone}
                                    </a>
                                    <span class="mx-2">•</span>
                                    <a href="mailto:${contact.profiles.contact_email}" class="hover:text-indigo-600">
                                        <i class="fas fa-envelope mr-1"></i>${contact.profiles.contact_email}
                                    </a>
                                </div>
                            </div>
                            <div class="text-right">
                                <div class="text-sm text-gray-500">
                                    Unlocked ${formatDate(contact.created_at)}
                                </div>
                            </div>
                        </div>
                    </div>
                `).join('');

            } catch (error) {
                console.error('Error loading unlocked contacts:', error);
            }
        }

        // Load recent payments
        async function loadRecentPayments(userId) {
            try {
                const { data: payments, error } = await supabase
                    .from('payments')
                    .select('*')
                    .eq('user_id', userId)
                    .order('created_at', { ascending: false })
                    .limit(5);

                if (error) throw error;

                const paymentsList = document.getElementById('recentPaymentsList');
                if (!payments?.length) {
                    paymentsList.innerHTML = `
                        <div class="text-center py-8 text-gray-500">
                            <i class="fas fa-receipt text-4xl mb-2"></i>
                            <p>No payments yet</p>
                        </div>
                    `;
                    return;
                }

                paymentsList.innerHTML = payments.map(payment => `
                    <div class="flex items-center justify-between p-4 border border-gray-100 rounded-lg">
                        <div>
                            <div class="font-medium text-gray-900">${formatCurrency(payment.amount)}</div>
                            <div class="text-sm text-gray-500">
                                ${payment.payment_type === 'maid_contact' ? 'Maid Contact' : 'Job Contact'}
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="text-sm font-medium text-green-600">Success</div>
                            <div class="text-sm text-gray-500">${formatDate(payment.created_at)}</div>
                        </div>
                    </div>
                `).join('');

            } catch (error) {
                console.error('Error loading recent payments:', error);
            }
        }

        // Export contacts
        async function exportContacts() {
            try {
                const { data: { user } } = await supabase.auth.getUser();
                if (!user) return;

                const { data: contacts, error } = await supabase
                    .from('unlocked_contacts')
                    .select(`
                        *,
                        profiles:maid_id (*)
                    `)
                    .eq('user_id', user.id);

                if (error) throw error;

                if (!contacts?.length) {
                    alert('No contacts to export');
                    return;
                }

                // Format contacts for CSV
                const csvData = contacts.map(contact => ({
                    'Name': contact.profiles.full_name,
                    'Phone': contact.profiles.contact_phone,
                    'Email': contact.profiles.contact_email,
                    'Location': contact.profiles.location,
                    'Experience': contact.profiles.experience,
                    'Working Hours': contact.profiles.working_hours,
                    'Expected Salary': contact.profiles.expected_salary,
                    'Unlocked On': formatDate(contact.created_at)
                }));

                // Convert to CSV
                const csv = [
                    Object.keys(csvData[0]).join(','),
                    ...csvData.map(row => Object.values(row).join(','))
                ].join('\n');

                // Download CSV
                const blob = new Blob([csv], { type: 'text/csv' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'citymaid-contacts.csv';
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);

            } catch (error) {
                console.error('Error exporting contacts:', error);
                alert('Failed to export contacts. Please try again.');
            }
        }

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', loadDashboardData);

        // Set current year in footer
        document.getElementById('currentYear').textContent = new Date().getFullYear();
    </script>

    <footer class="border-t border-gray-800">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
            <p class="text-center text-gray-400">&copy; <span id="currentYear"></span> City Maid Services. All rights reserved.</p>
        </div>
    </footer>
</body>
</html>