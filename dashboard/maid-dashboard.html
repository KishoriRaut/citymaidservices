<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Maid Dashboard - CityMaid</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Poppins', sans-serif;
        }
        .stat-card {
            @apply bg-white rounded-xl p-6 border border-gray-100 hover:shadow-lg transition-all duration-300;
        }
        .stat-icon {
            @apply w-12 h-12 rounded-full flex items-center justify-center text-xl;
        }
        .activity-indicator {
            @apply w-3 h-3 rounded-full;
        }
        .activity-indicator.active {
            @apply bg-green-500;
        }
        .activity-indicator.inactive {
            @apply bg-red-500;
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Navigation -->
    <nav class="bg-white border-b border-gray-100">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <!-- Left side -->
                <div class="flex">
                    <div class="flex-shrink-0 flex items-center">
                        <a href="index.html" class="text-2xl font-bold text-indigo-600">CityMaid</a>
                    </div>
                </div>

                <!-- Right side -->
                <div class="flex items-center space-x-4">
                    <!-- Notifications -->
                    <button class="relative p-2 text-gray-400 hover:text-gray-500">
                        <i class="fas fa-bell"></i>
                        <span id="notificationBadge" class="hidden absolute top-0 right-0 block h-2 w-2 rounded-full bg-red-500"></span>
                    </button>

                    <!-- Profile dropdown -->
                    <div class="relative" id="profileDropdown">
                        <button class="flex items-center space-x-3 focus:outline-none">
                            <img id="userAvatar" src="https://via.placeholder.com/32" alt="Profile"
                                class="h-8 w-8 rounded-full object-cover">
                            <span id="userName" class="text-sm font-medium text-gray-700">Loading...</span>
                            <i class="fas fa-chevron-down text-gray-400 text-sm"></i>
                        </button>
                        <!-- Dropdown menu -->
                        <div class="hidden absolute right-0 mt-2 w-48 rounded-md shadow-lg bg-white ring-1 ring-black ring-opacity-5">
                            <div class="py-1">
                                <a href="profile-settings.html" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                                    <i class="fas fa-cog mr-2"></i>Settings
                                </a>
                                <button onclick="signOut()" class="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                                    <i class="fas fa-sign-out-alt mr-2"></i>Sign out
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Welcome Section -->
        <div class="bg-white rounded-xl p-6 mb-8">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-2xl font-bold text-gray-900">Welcome, <span id="welcomeName">Maid</span>!</h1>
                    <p class="text-gray-600 mt-1">Manage your profile and track your visibility</p>
                </div>
                <div class="flex items-center space-x-2">
                    <span class="activity-indicator active"></span>
                    <span id="profileStatus" class="text-sm font-medium text-gray-600">Profile Active</span>
                </div>
            </div>
        </div>

        <!-- Stats Grid -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <!-- Profile Views -->
            <div class="stat-card">
                <div class="flex items-start justify-between">
                    <div>
                        <p class="text-sm text-gray-500">Profile Views</p>
                        <h3 class="text-2xl font-bold text-gray-900 mt-1" id="profileViews">0</h3>
                        <p class="text-sm text-gray-500 mt-1">Last 30 days</p>
                    </div>
                    <div class="stat-icon bg-blue-50 text-blue-600">
                        <i class="fas fa-eye"></i>
                    </div>
                </div>
            </div>

            <!-- Contact Unlocks -->
            <div class="stat-card">
                <div class="flex items-start justify-between">
                    <div>
                        <p class="text-sm text-gray-500">Contact Unlocks</p>
                        <h3 class="text-2xl font-bold text-gray-900 mt-1" id="contactUnlocks">0</h3>
                        <p class="text-sm text-gray-500 mt-1">Total unlocks</p>
                    </div>
                    <div class="stat-icon bg-green-50 text-green-600">
                        <i class="fas fa-unlock"></i>
                    </div>
                </div>
            </div>

            <!-- Profile Rating -->
            <div class="stat-card">
                <div class="flex items-start justify-between">
                    <div>
                        <p class="text-sm text-gray-500">Verification Status</p>
                        <h3 class="text-2xl font-bold text-gray-900 mt-1" id="verificationStatus">Pending</h3>
                        <p class="text-sm text-gray-500 mt-1">Identity verification</p>
                    </div>
                    <div class="stat-icon bg-yellow-50 text-yellow-600">
                        <i class="fas fa-shield-alt"></i>
                    </div>
                </div>
            </div>

            <!-- Profile Completion -->
            <div class="stat-card">
                <div class="flex items-start justify-between">
                    <div>
                        <p class="text-sm text-gray-500">Profile Completion</p>
                        <h3 class="text-2xl font-bold text-gray-900 mt-1" id="profileCompletion">0%</h3>
                        <p class="text-sm text-gray-500 mt-1">Complete your profile</p>
                    </div>
                    <div class="stat-icon bg-purple-50 text-purple-600">
                        <i class="fas fa-user-check"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Grid -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Left Column (2 cols) -->
            <div class="lg:col-span-2 space-y-8">
                <!-- Profile Overview -->
                <div class="bg-white rounded-xl p-6">
                    <div class="flex justify-between items-start mb-6">
                        <div>
                            <h2 class="text-xl font-bold text-gray-800">My Profile</h2>
                            <p class="text-gray-600 mt-1">Your public profile information</p>
                        </div>
                        <a href="edit-profile.html" class="text-indigo-600 hover:text-indigo-700">
                            <i class="fas fa-edit mr-1"></i>Edit Profile
                        </a>
                    </div>
                    <div id="profileOverview" class="space-y-6">
                        <!-- Profile information will be loaded here -->
                    </div>
                </div>

                <!-- Recent Profile Views -->
                <div class="bg-white rounded-xl p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-xl font-bold text-gray-800">Recent Profile Views</h2>
                        <span class="text-sm text-gray-500">Last 30 days</span>
                    </div>
                    <div id="profileViewsList" class="space-y-4">
                        <!-- Profile views will be loaded here -->
                    </div>
                </div>
            </div>

            <!-- Right Column -->
            <div class="space-y-8">
                <!-- Quick Actions -->
                <div class="bg-white rounded-xl p-6">
                    <h2 class="text-xl font-bold text-gray-800 mb-4">Quick Actions</h2>
                    <div class="space-y-3">
                        <button onclick="toggleProfileStatus()" class="w-full bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 transition-colors">
                            <i class="fas fa-power-off mr-2"></i>Toggle Availability
                        </button>
                        <a href="find-jobs.html" class="block w-full bg-white text-indigo-600 px-4 py-2 rounded-lg border-2 border-indigo-600 hover:bg-indigo-50 transition-colors text-center">
                            <i class="fas fa-search mr-2"></i>Find Jobs
                        </a>
                    </div>
                </div>

                <!-- Recent Contact Unlocks -->
                <div class="bg-white rounded-xl p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-xl font-bold text-gray-800">Recent Unlocks</h2>
                        <button onclick="exportUnlocks()" class="text-indigo-600 hover:text-indigo-700 text-sm">
                            <i class="fas fa-download mr-1"></i>Export
                        </button>
                    </div>
                    <div id="recentUnlocksList" class="space-y-4">
                        <!-- Recent unlocks will be loaded here -->
                    </div>
                </div>

                <!-- Verification Status -->
                <div class="bg-white rounded-xl p-6">
                    <h2 class="text-xl font-bold text-gray-800 mb-4">Verification Status</h2>
                    <div class="space-y-4">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center">
                                <i class="fas fa-id-card text-indigo-600 mr-3"></i>
                                <span class="text-gray-700">Identity Verification</span>
                            </div>
                            <span id="idVerification" class="px-3 py-1 rounded-full text-sm font-medium bg-yellow-100 text-yellow-800">
                                Pending
                            </span>
                        </div>
                        <div class="flex items-center justify-between">
                            <div class="flex items-center">
                                <i class="fas fa-phone-alt text-indigo-600 mr-3"></i>
                                <span class="text-gray-700">Phone Verification</span>
                            </div>
                            <span id="phoneVerification" class="px-3 py-1 rounded-full text-sm font-medium bg-green-100 text-green-800">
                                Verified
                            </span>
                        </div>
                        <div class="flex items-center justify-between">
                            <div class="flex items-center">
                                <i class="fas fa-envelope text-indigo-600 mr-3"></i>
                                <span class="text-gray-700">Email Verification</span>
                            </div>
                            <span id="emailVerification" class="px-3 py-1 rounded-full text-sm font-medium bg-green-100 text-green-800">
                                Verified
                            </span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <footer class="border-t border-gray-800">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
            <p class="text-center text-gray-400">&copy; <span id="currentYear"></span> City Maid Services. All rights reserved.</p>
        </div>
    </footer>

    <script type="module">
        import { supabase } from './js/supabaseClient.js';
        import { utils } from './js/utils.js';

        // Format date for profile views
        function formatViewDate(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const diff = now - date;
            const days = Math.floor(diff / (1000 * 60 * 60 * 24));
            
            if (days === 0) return 'Today';
            if (days === 1) return 'Yesterday';
            if (days < 7) return `${days} days ago`;
            return utils.formatDate(dateString);
        }

        // Load dashboard data
        async function loadDashboardData() {
            try {
                const { data: { user } } = await supabase.auth.getUser();
                if (!user) {
                    window.location.href = 'signin.html';
                    return;
                }

                // Get maid profile
                const { data: maid, error: maidError } = await supabase
                    .from('maids')
                    .select('*')
                    .eq('user_id', user.id)
                    .single();

                if (maidError) throw maidError;

                // Update profile overview
                updateProfileOverview(maid);

                // Update stats
                await loadStats(maid.id);

                // Load profile views
                await loadProfileViews(maid.id);

                // Load recent unlocks
                await loadRecentUnlocks(maid.id);

                // Update verification status
                updateVerificationStatus(maid);

                // Update user name
                document.getElementById('userName').textContent = maid.full_name;
                document.getElementById('welcomeName').textContent = maid.full_name.split(' ')[0];

                // Update profile status
                const statusIndicator = document.querySelector('.activity-indicator');
                const statusText = document.getElementById('profileStatus');
                if (maid.is_active) {
                    statusIndicator.classList.add('active');
                    statusIndicator.classList.remove('inactive');
                    statusText.textContent = 'Profile Active';
                } else {
                    statusIndicator.classList.add('inactive');
                    statusIndicator.classList.remove('active');
                    statusText.textContent = 'Profile Inactive';
                }

            } catch (error) {
                console.error('Error loading dashboard:', error);
                utils.showError('Failed to load dashboard data');
            }
        }

        // Update profile overview
        function updateProfileOverview(maid) {
            const profileOverview = document.getElementById('profileOverview');
            profileOverview.innerHTML = `
                <div class="flex items-start gap-6">
                    <img src="${maid.profile_image || 'https://via.placeholder.com/150'}" 
                         alt="Profile" 
                         class="w-32 h-32 rounded-lg object-cover">
                    <div class="flex-1">
                        <h3 class="text-xl font-semibold text-gray-900">${maid.full_name}</h3>
                        <p class="text-gray-600">${maid.location}</p>
                        <div class="flex items-center gap-4 mt-2">
                            <span class="text-sm text-gray-500">
                                <i class="fas fa-briefcase mr-1"></i>${maid.experience}
                            </span>
                            <span class="text-sm text-gray-500">
                                <i class="fas fa-clock mr-1"></i>${maid.working_hours}
                            </span>
                            <span class="text-sm text-gray-500">
                                <i class="fas fa-money-bill mr-1"></i>${utils.formatCurrency(maid.expected_salary)}/month
                            </span>
                        </div>
                    </div>
                </div>
                <div class="mt-6">
                    <h4 class="font-medium text-gray-900 mb-2">Services Offered</h4>
                    <div class="flex flex-wrap gap-2">
                        ${maid.services.map(service => `
                            <span class="px-3 py-1 bg-indigo-100 text-indigo-800 rounded-full text-sm font-medium">
                                ${service}
                            </span>
                        `).join('')}
                    </div>
                </div>
                <div class="mt-6">
                    <h4 class="font-medium text-gray-900 mb-2">About Me</h4>
                    <p class="text-gray-600">${maid.description || 'No description available'}</p>
                </div>
            `;
        }

        // Load stats
        async function loadStats(maidId) {
            try {
                // Get profile views count (last 30 days)
                const thirtyDaysAgo = new Date();
                thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);

                const { data: views, error: viewsError } = await supabase
                    .from('profile_views')
                    .select('id')
                    .eq('maid_id', maidId)
                    .gte('viewed_at', thirtyDaysAgo.toISOString());

                // Get contact unlocks count
                const { data: unlocks, error: unlocksError } = await supabase
                    .from('unlocked_contacts')
                    .select('id')
                    .eq('maid_id', maidId);

                // Update stats
                document.getElementById('profileViews').textContent = views?.length || 0;
                document.getElementById('contactUnlocks').textContent = unlocks?.length || 0;

            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }

        // Load profile views
        async function loadProfileViews(maidId) {
            try {
                const thirtyDaysAgo = new Date();
                thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);

                const { data: views, error } = await supabase
                    .from('profile_views')
                    .select('*, users(*)')
                    .eq('maid_id', maidId)
                    .gte('viewed_at', thirtyDaysAgo.toISOString())
                    .order('viewed_at', { ascending: false })
                    .limit(5);

                if (error) throw error;

                const viewsList = document.getElementById('profileViewsList');
                if (!views?.length) {
                    viewsList.innerHTML = `
                        <div class="text-center py-8 text-gray-500">
                            <i class="fas fa-eye-slash text-4xl mb-2"></i>
                            <p>No profile views yet</p>
                        </div>
                    `;
                    return;
                }

                viewsList.innerHTML = views.map(view => `
                    <div class="flex items-center justify-between p-4 border border-gray-100 rounded-lg">
                        <div class="flex items-center">
                            <img src="${view.users.avatar_url || 'https://via.placeholder.com/32'}" 
                                 alt="Viewer" 
                                 class="w-10 h-10 rounded-full mr-3">
                            <div>
                                <div class="font-medium text-gray-900">${view.users.full_name || 'Anonymous User'}</div>
                                <div class="text-sm text-gray-500">${view.users.location || 'Location not specified'}</div>
                            </div>
                        </div>
                        <div class="text-right text-sm text-gray-500">
                            ${formatViewDate(view.viewed_at)}
                        </div>
                    </div>
                `).join('');

            } catch (error) {
                console.error('Error loading profile views:', error);
            }
        }

        // Load recent unlocks
        async function loadRecentUnlocks(maidId) {
            try {
                const { data: unlocks, error } = await supabase
                    .from('unlocked_contacts')
                    .select('*, users(*)')
                    .eq('maid_id', maidId)
                    .order('created_at', { ascending: false })
                    .limit(5);

                if (error) throw error;

                const unlocksList = document.getElementById('recentUnlocksList');
                if (!unlocks?.length) {
                    unlocksList.innerHTML = `
                        <div class="text-center py-8 text-gray-500">
                            <i class="fas fa-unlock-alt text-4xl mb-2"></i>
                            <p>No contact unlocks yet</p>
                        </div>
                    `;
                    return;
                }

                unlocksList.innerHTML = unlocks.map(unlock => `
                    <div class="flex items-center justify-between p-4 border border-gray-100 rounded-lg">
                        <div class="flex items-center">
                            <img src="${unlock.users.avatar_url || 'https://via.placeholder.com/32'}" 
                                 alt="Employer" 
                                 class="w-10 h-10 rounded-full mr-3">
                            <div>
                                <div class="font-medium text-gray-900">${unlock.users.full_name || 'Anonymous Employer'}</div>
                                <div class="text-sm text-gray-500">${unlock.users.location || 'Location not specified'}</div>
                            </div>
                        </div>
                        <div class="text-right text-sm text-gray-500">
                            ${utils.formatDate(unlock.created_at)}
                        </div>
                    </div>
                `).join('');

            } catch (error) {
                console.error('Error loading recent unlocks:', error);
            }
        }

        // Update verification status
        function updateVerificationStatus(maid) {
            const verificationStatus = document.getElementById('verificationStatus');
            const idVerification = document.getElementById('idVerification');
            const phoneVerification = document.getElementById('phoneVerification');
            const emailVerification = document.getElementById('emailVerification');

            // Update verification badges
            switch (maid.verification_status) {
                case 'verified':
                    verificationStatus.textContent = 'Verified';
                    idVerification.className = 'px-3 py-1 rounded-full text-sm font-medium bg-green-100 text-green-800';
                    idVerification.textContent = 'Verified';
                    break;
                case 'pending':
                    verificationStatus.textContent = 'Pending';
                    idVerification.className = 'px-3 py-1 rounded-full text-sm font-medium bg-yellow-100 text-yellow-800';
                    idVerification.textContent = 'Pending';
                    break;
                case 'rejected':
                    verificationStatus.textContent = 'Rejected';
                    idVerification.className = 'px-3 py-1 rounded-full text-sm font-medium bg-red-100 text-red-800';
                    idVerification.textContent = 'Rejected';
                    break;
            }
        }

        // Toggle profile status
        async function toggleProfileStatus() {
            try {
                const { data: { user } } = await supabase.auth.getUser();
                if (!user) return;

                const { data: maid, error: fetchError } = await supabase
                    .from('maids')
                    .select('is_active')
                    .eq('user_id', user.id)
                    .single();

                if (fetchError) throw fetchError;

                const { error: updateError } = await supabase
                    .from('maids')
                    .update({ is_active: !maid.is_active })
                    .eq('user_id', user.id);

                if (updateError) throw updateError;

                // Reload dashboard
                loadDashboardData();
                utils.showSuccess(`Profile ${!maid.is_active ? 'activated' : 'deactivated'} successfully`);

            } catch (error) {
                console.error('Error toggling profile status:', error);
                utils.showError('Failed to update profile status');
            }
        }

        // Export unlocks
        async function exportUnlocks() {
            try {
                const { data: { user } } = await supabase.auth.getUser();
                if (!user) return;

                const { data: unlocks, error } = await supabase
                    .from('unlocked_contacts')
                    .select('*, users(*)')
                    .eq('maid_id', user.id);

                if (error) throw error;

                if (!unlocks?.length) {
                    utils.showError('No unlocks to export');
                    return;
                }

                // Format data for CSV
                const csvData = unlocks.map(unlock => ({
                    'Employer Name': unlock.users.full_name || 'Anonymous',
                    'Location': unlock.users.location || 'Not specified',
                    'Unlocked On': utils.formatDate(unlock.created_at)
                }));

                // Create CSV content
                const csv = [
                    Object.keys(csvData[0]).join(','),
                    ...csvData.map(row => Object.values(row).join(','))
                ].join('\n');

                // Download CSV
                const blob = new Blob([csv], { type: 'text/csv' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'contact-unlocks.csv';
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);

            } catch (error) {
                console.error('Error exporting unlocks:', error);
                utils.showError('Failed to export unlocks');
            }
        }

        // Profile dropdown toggle
        const profileDropdown = document.getElementById('profileDropdown');
        const dropdownMenu = profileDropdown.querySelector('.hidden');
        
        profileDropdown.addEventListener('click', () => {
            dropdownMenu.classList.toggle('hidden');
        });

        // Close dropdown when clicking outside
        document.addEventListener('click', (e) => {
            if (!profileDropdown.contains(e.target)) {
                dropdownMenu.classList.add('hidden');
            }
        });

        // Sign out function
        window.signOut = async () => {
            try {
                const { error } = await supabase.auth.signOut();
                if (error) throw error;
                window.location.href = 'signin.html';
            } catch (error) {
                console.error('Error signing out:', error);
                utils.showError('Failed to sign out');
            }
        };

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', loadDashboardData);

        // Make functions available globally
        window.toggleProfileStatus = toggleProfileStatus;
        window.exportUnlocks = exportUnlocks;

        // Set current year in footer
        document.getElementById('currentYear').textContent = new Date().getFullYear();
    </script>
</body>
</html>